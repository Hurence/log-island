#########################################################################################################
# Logisland Rubix Web Analytics
# Receive web events from eventhubs, treat them then push events and sessions into opendistro cluster
#########################################################################################################

version: 1.4.0
documentation: Logisland Rubix Webanalytics

engine:
  component: com.hurence.logisland.engine.spark.KafkaStreamProcessingEngine
  type: engine
  documentation: Receive web events from kafka, treat them and push events and sessions on opendsitro/es cluster
  configuration:
    spark.app.name: LogislandWebanalytics
    spark.master: local[3]
#    spark.driver.memory: 2G
#    spark.driver.cores: 1
#    spark.executor.memory: 4G
#    spark.executor.instances: 1
#    spark.executor.cores: 4
#    spark.executor.cores: 1
#    spark.yarn.queue: default
#    spark.yarn.maxAppAttempts: 4
#    spark.yarn.am.attemptFailuresValidityInterval: 1h
#    spark.yarn.max.executor.failures: 20
#    spark.yarn.executor.failuresValidityInterval: 1h
#    spark.task.maxFailures: 8
#    spark.serializer: org.apache.spark.serializer.KryoSerializer
    #    spark.streaming.backpressure.enabled: false
#    spark.streaming.backpressure.enabled: true
#    spark.streaming.unpersist: false
#    spark.streaming.blockInterval: 500
#    spark.streaming.timeout: -1
#    spark.streaming.kafka.maxRetries: 3
#    spark.streaming.ui.retainedBatches: 200
#    spark.streaming.receiver.writeAheadLog.enable: false
#    spark.ui.port: 4054
#    spark.streaming.kafka.maxRatePerPartition: 3000
#    spark.streaming.batchDuration: 5000

  controllerServiceConfigurations:

    # Kafka sink configuration
    - controllerService: kafka_service
      component: com.hurence.logisland.stream.spark.structured.provider.KafkaStructuredStreamProviderService
      configuration:
#        output.mode: "complete"
        kafka.input.topics: test-simple
        kafka.output.topics: logisland_out
        kafka.error.topics: logisland_errors
        kafka.input.topics.serializer: com.hurence.logisland.serializer.ExtendedJsonSerializer
        kafka.output.topics.serializer: com.hurence.logisland.serializer.ExtendedJsonSerializer
        kafka.error.topics.serializer: com.hurence.logisland.serializer.ExtendedJsonSerializer
#        kafka.metadata.broker.list: kafka:9092
        kafka.zookeeper.quorum: ${kafka.zookeeper.quorum}
        kafka.topic.autoCreate: true
        kafka.topic.default.partitions: 1
        kafka.topic.default.replicationFactor: 1

    - controllerService: console_service
      component: com.hurence.logisland.stream.spark.structured.provider.ConsoleStructuredStreamProviderService
      configuration:
        output.mode: "update"
        truncate: false


#    - controllerService: opendistro_service
#      component: com.hurence.logisland.service.elasticsearch.Elasticsearch_7_x_ClientService
#      type: service
#      documentation: OpenDistro Service
#      configuration:
#        # SVAZ-VLP-OD01: 10.232.68.16
#        # SVAZ-VLP-OD02: 110.232.68.11
#        # SVAZ-VLP-OD03: 10.232.68.17
#        # SVAZ-VLP-OD04: 10.232.68.15
#        # SVAZ-VLP-OD05: 10.232.68.18
#        hosts: 10.232.68.16:9200,10.232.68.11:9200,10.232.68.17:9200,10.232.68.15:9200,10.232.68.18:9200
#        username: admin
#        password: admin
#        batch.size: 2000
#        flush.interval: 2

#    - controllerService: elasticsearch_service
#        component: com.hurence.logisland.service.elasticsearch.Elasticsearch_2_4_0_ClientService
#        type: service
#        documentation: elasticsearch 2.4.0 service implementation
#        configuration:
#          hosts: ns3004505.ovh.net:9300,ns3005860.ovh.net:9300,ns3050034.ovh.net:9300
#          cluster.name: iph-cluster
#          batch.size: 2000
#          flush.interval: 2

#    - controllerService: lru_cache_service_domain
#      component: com.hurence.logisland.service.cache.LRUKeyValueCacheService
#      type: service
#      documentation: Cache service for Ip to Geo service to keep resolved addresses geo information
#      configuration:
#        cache.size: 100000
#
#    - controllerService: ip_to_geo_service
#      component: com.hurence.logisland.service.iptogeo.maxmind.MaxmindIpToGeoService
#      type: service
#      documentation: Service to get geo information from an ip address using maxmind DB
#      configuration:
#        maxmind.database.uri: dbfs:/FileStore/logisland/maxmind/GeoLite2-City.mmdb
#        locale: fr



  streamConfigurations:

    - stream: kafka_to_console
      component: com.hurence.logisland.stream.spark.structured.StructuredStream
      configuration:
        read.stream.service.provider: kafka_service
        read.topics.serializer: com.hurence.logisland.serializer.ExtendedJsonSerializer
        read.topics.key.serializer: com.hurence.logisland.serializer.StringSerializer
        write.stream.service.provider: console_service
#        write.topics.serializer: com.hurence.logisland.serializer.ExtendedJsonSerializer
#        write.topics.key.serializer: com.hurence.logisland.serializer.StringSerializer
#        avro.input.schema: >
#          { "version": 1,
#            "name": "io.divolte.examples.record",
#            "type": "record",
#            "fields": [
#              { "name": "h2kTimestamp",            "type": "long" },
#              { "name": "remoteHost",              "type": "string"},
#              { "name": "record_type",             "type": ["null", "string"], "default": null },
#              { "name": "record_id",               "type": ["null", "string"], "default": null },
#              { "name": "location",                "type": ["null", "string"], "default": null },
#              { "name": "hitType",                 "type": ["null", "string"], "default": null },
#              { "name": "eventCategory",           "type": ["null", "string"], "default": null },
#              { "name": "eventAction",             "type": ["null", "string"], "default": null },
#              { "name": "eventLabel",              "type": ["null", "string"], "default": null },
#              { "name": "localPath",               "type": ["null", "string"], "default": null },
#              { "name": "q",                       "type": ["null", "string"], "default": null },
#              { "name": "n",                       "type": ["null", "int"],    "default": null },
#              { "name": "referer",                 "type": ["null", "string"], "default": null},
#              { "name": "viewportPixelWidth",      "type": ["null", "int"],    "default": null},
#              { "name": "viewportPixelHeight",     "type": ["null", "int"],    "default": null},
#              { "name": "screenPixelWidth",        "type": ["null", "int"],    "default": null},
#              { "name": "screenPixelHeight",       "type": ["null", "int"],    "default": null},
#              { "name": "partyId",                 "type": ["null", "string"], "default": null},
#              { "name": "sessionId",               "type": ["null", "string"], "default": null},
#              { "name": "pageViewId",              "type": ["null", "string"], "default": null},
#              { "name": "is_newSession",           "type": ["null", "boolean"], "default": null},
#              { "name": "userAgentString",         "type": ["null", "string"], "default": null},
#              { "name": "pageType",                "type": ["null", "string"], "default": null},
#              { "name": "Userid",                  "type": ["null", "string"], "default": null},
#              { "name": "B2BUnit",                 "type": ["null", "string"], "default": null},
#              { "name": "pointOfService",          "type": ["null", "string"], "default": null},
#              { "name": "companyID",               "type": ["null", "string"], "default": null},
#              { "name": "GroupCode",               "type": ["null", "string"], "default": null},
#              { "name": "userRoles",               "type": ["null", "string"], "default": null},
#              { "name": "is_PunchOut",             "type": ["null", "string"], "default": null},
#              { "name": "codeProduct",             "type": ["null", "string"], "default": null},
#              { "name": "categoryProductId",       "type": ["null", "string"], "default": null},
#              { "name": "categoryName",            "type": ["null", "string"], "default": null},
#              { "name": "categoryCode",            "type": ["null", "string"], "default": null},
#              { "name": "categoryNiv5",            "type": ["null", "string"], "default": null},
#              { "name": "categoryNiv4",            "type": ["null", "string"], "default": null},
#              { "name": "categoryNiv3",            "type": ["null", "string"], "default": null},
#              { "name": "categoryNiv2",            "type": ["null", "string"], "default": null},
#              { "name": "categoryNiv1",            "type": ["null", "string"], "default": null},
#              { "name": "countryCode",             "type": ["null", "string"], "default": null},
#              { "name": "Company",                 "type": ["null", "string"], "default": null},
#              { "name": "is_Link",                 "type": ["null", "boolean"], "default": null},
#              { "name": "clickText",               "type": ["null", "string"], "default": null},
#              { "name": "clickURL",                "type": ["null", "string"], "default": null},
#              { "name": "newCustomerWebOnly",      "type": ["null", "int"], "default": null},
#              { "name": "newCustomerWebOrAgency",  "type": ["null", "int"], "default": null},
#              { "name": "productPrice",            "type": ["null", "float"], "default": null},
#              { "name": "searchedProductIndex",    "type": ["null", "int"], "default": null},
#              { "name": "searchedProductPage",     "type": ["null", "int"], "default": null},
#              { "name": "stockInfo",               "type": ["null", "string"], "default": null},
#              { "name": "transactionId",           "type": ["null", "string"], "default": null},
#              { "name": "transactionTotal",        "type": ["null", "float"], "default": null},
#              { "name": "transactionCurrency",     "type": ["null", "string"], "default": null},
#              { "name": "productQuantity",         "type": ["null", "int"], "default": null},
#              { "name": "Alt",                     "type": ["null", "string"], "default": null},
#              { "name": "erpLocaleCode",           "type": ["null", "string"], "default": null},
#              { "name": "salesOrg",                "type": ["null", "string"], "default": null},
#              { "name": "country",                 "type": ["null", "string"], "default": null},
#              { "name": "currency",                "type": ["null", "string"], "default": null},
#              { "name": "currentCart",             "type": ["null", {"type": "array", "items":{
#                  "name": "Product", "type": "record", "fields":[
#                    {"name": "price", "type": "double"},
#                    {"name": "quantity", "type": "int"},
#                    {"name": "sku", "type": "string"}
#                  ]}
#                }],
#                "default": null
#              }
#            ]
#          }
      processorConfigurations:

        # Create or update web session based on web events
#        - processor: consolidate_session
#          component: com.hurence.logisland.processor.webAnalytics.IncrementalWebSession
#          type: processor
#          documentation: compute session duration as well as other informations
#          configuration:
#            session.timeout: 1800
#            userid.field: Userid
#            fields.to.return: partyId,Company,remoteHost,tagOrigin,sourceOrigin,spamOrigin,referer,userAgentString,utm_source,utm_campaign,utm_medium,utm_content,utm_term,alert_match_name,alert_match_query,referer_hostname,DeviceClass,AgentName,ImportanceCode,B2BUnit,libelle_zone,Userid,customer_category,source_of_traffic_source,source_of_traffic_medium,source_of_traffic_keyword,source_of_traffic_campaign,source_of_traffic_organic_search,source_of_traffic_content,source_of_traffic_referral_path,websessionIndex
#            elasticsearch.client.service: opendistro_service
##            es.session.index.field: websessionIndex
#            es.session.type.name: sessions
#            es.event.index.prefix: openanalytics_webevents
#            es.event.type.name: event
#            es.mapping.event.to.session.index.name: openanalytics_websession_mappings
##            debug: true

        # put to opendistro
#        - processor: opendistro_es_publisher
#          component: com.hurence.logisland.processor.elasticsearch.BulkAddElasticsearch
#          type: processor
#          documentation: a processor that stores the web sessions
#          configuration:
##            es.index.field: websessionIndex
#            elasticsearch.client.service: opendistro_service
#            default.index: openanalytics_default
#            default.type: default
#            es.index.field: es_index
#            es.type.field: es_type

        - processor: debug
          component: com.hurence.logisland.processor.DebugStream
          type: processor
          documentation: print input

